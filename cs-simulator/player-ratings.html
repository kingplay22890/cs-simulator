<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-slate-200">
  <div class="container mx-auto p-6">
    <!-- –®–∞–ø–∫–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-4xl font-bold">–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h1>
      <div class="flex gap-3">
        <a href="index.html" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">‚Üê –ù–∞–∑–∞–¥</a>
        <a href="ratings.html" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">üìä –†–µ–π—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥</a>
      </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg border border-gray-700/50">
      <div class="space-y-6">
        <!-- –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞ -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-3">üîç –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞</label>
          <input id="playerSearch" class="player-search-input w-full" type="text" placeholder="–ù–∞–π—Ç–∏ –∏–≥—Ä–æ–∫–∞ (Enter ‚Äî —Å–ª–µ–¥—É—é—â–∏–π)" />
        </div>

        <!-- –ü–µ—Ä–∏–æ–¥ -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-3">üìÖ –ü–µ—Ä–∏–æ–¥</label>
          <div class="filter-button-group" id="periodFilterGroup">
            <button class="filter-btn" data-value="all">–í—Å–µ –º–∞—Ç—á–∏</button>
            <button class="filter-btn" data-value="last10">10 –º–∞—Ç—á–µ–π</button>
            <button class="filter-btn" data-value="last3m">3 –º–µ—Å—è—Ü–∞</button>
            <button class="filter-btn" data-value="last6m">6 –º–µ—Å—è—Ü–µ–≤</button>
            <button class="filter-btn" data-value="last12m">12 –º–µ—Å—è—Ü–µ–≤</button>
            <button class="filter-btn" data-value="year2025">2025</button>
            <button class="filter-btn" data-value="year2026">2026</button>
          </div>
        </div>

        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-3">üîÑ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <div class="filter-button-group" id="sortFilterGroup">
            <button class="filter-btn" data-value="rating_desc">–†–µ–π—Ç–∏–Ω–≥ ‚Üì</button>
            <button class="filter-btn" data-value="rating_asc">–†–µ–π—Ç–∏–Ω–≥ ‚Üë</button>
            <button class="filter-btn" data-value="matches">–ú–∞—Ç—á–∏</button>
            <button class="filter-btn" data-value="composite">–¢–æ–ø Score</button>
          </div>
        </div>

        <!-- –ú–∏–Ω–∏–º—É–º –º–∞—Ç—á–µ–π -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-3">‚ö° –ú–∏–Ω–∏–º—É–º –º–∞—Ç—á–µ–π</label>
          <div class="filter-button-group" id="minMatchesFilterGroup">
            <button class="filter-btn" data-value="0">–í—Å–µ</button>
            <button class="filter-btn" data-value="5">5+</button>
            <button class="filter-btn" data-value="10">10+</button>
            <button class="filter-btn" data-value="15">15+</button>
            <button class="filter-btn" data-value="20">20+</button>
            <button class="filter-btn" data-value="50">50+</button>
            <button class="filter-btn" data-value="100">100+</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700/50">
      <table class="w-full">
        <thead>
          <tr class="bg-gray-700/50 border-b border-gray-700">
            <th class="px-6 py-4 text-left">#</th>
            <th class="px-6 py-4 text-left">–ò–≥—Ä–æ–∫</th>
            <th class="px-6 py-4 text-left">–ö–æ–º–∞–Ω–¥–∞</th>
            <th class="px-6 py-4 text-center">–ú–∞—Ç—á–µ–π</th>
            <th class="px-6 py-4 text-center">–†–µ–π—Ç–∏–Ω–≥</th>
            <th class="px-6 py-4 text-center">Score</th>
            <th class="px-6 py-4 text-center">–ü–æ–±–µ–¥</th>
            <th class="px-6 py-4 text-center">Win Rate</th>
            <th class="px-6 py-4 text-center">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</th>
          </tr>
        </thead>
        <tbody id="playersTableBody">
          <tr>
            <td colspan="8" class="px-6 py-8 text-center text-gray-400">–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/player-awards-store.js"></script>
  <script>
    let allTeams = [];
    let currentPeriod = 'all';
    let currentSort = 'rating_desc';

    async function loadTeamsData() {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –ø–∞–¥–∞–µ–º –Ω–∞ localStorage
        let teams = [];
        if (window.csApi) {
          teams = await window.csApi.fetchTeams();
        } else {
          const raw = localStorage.getItem('cs_teams');
          teams = JSON.parse(raw || '[]');
        }
        allTeams = teams;
        console.log('Teams loaded:', allTeams);
        console.log('Total teams:', allTeams.length);
        allTeams.forEach(team => {
          console.log(`Team: ${team.name}, History length: ${team.history ? team.history.length : 0}`);
          if (team.history && team.history[0]) {
            console.log('First match:', team.history[0]);
          }
        });
        renderPlayersTable();
      } catch (e) {
        console.error('Error loading teams:', e);
        allTeams = [];
      }
    }
    function filterHistoryByPeriod(history, period) {
        if (!Array.isArray(history)) return [];
        if (!period || period === 'all') return history;
        if (period === 'last10') return history.slice(0, 10);
        const now = new Date();
        if (period === 'last3m' || period === 'last6m' || period === 'last12m') {
          const months = period === 'last3m' ? 3 : period === 'last6m' ? 6 : 12;
          const cutoff = new Date(now);
          cutoff.setMonth(cutoff.getMonth() - months);
          return history.filter(m => {
            const d = new Date(m.date || m.startedAt || m.matchDate || null);
            return !isNaN(d.getTime()) && d >= cutoff;
          });
        }
        if (period === 'year2025' || period === 'year2026') {
          const year = period === 'year2025' ? 2025 : 2026;
          return history.filter(m => {
            const d = new Date(m.date || m.startedAt || m.matchDate || null);
            return !isNaN(d.getTime()) && d.getFullYear() === year;
          });
        }
        return history;
      }

      function getPlayerStats(playerName, team, period) {
      let matchCount = 0;
      let wins = 0;
      let ratingSum = 0;
      let photoUrl = '';

      if (Array.isArray(team.history)) {
        const historyToUse = filterHistoryByPeriod(team.history, period);

        historyToUse.forEach(match => {
          let playersList = null;
          if (Array.isArray(match.playerStats)) {
            playersList = match.playerStats;
          } else if (Array.isArray(match.players)) {
            playersList = match.players;
          }
          
          if (playersList) {
            const foundPlayer = playersList.find(p => p.name === playerName);
            if (foundPlayer) {
              matchCount++;
              ratingSum += foundPlayer.rating2 || foundPlayer.rating || 0;
              if (!photoUrl && foundPlayer.photoUrl) {
                photoUrl = foundPlayer.photoUrl;
              }
              if (match.result === 'Win') {
                wins++;
              }
            }
          }
        });
      }

      return {
        matches: matchCount,
        wins: wins,
        avgRating: matchCount > 0 ? (ratingSum / matchCount).toFixed(2) : 0,
        winRate: matchCount > 0 ? Math.round((wins / matchCount) * 100) : 0,
        photoUrl: photoUrl
      };
    }

    function renderPlayersTable() {
      const tbody = document.getElementById('playersTableBody');
      // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
      const periodBtn = document.querySelector('#periodFilterGroup .filter-btn.active');
      const sortBtn = document.querySelector('#sortFilterGroup .filter-btn.active');
      const minMatchesBtn = document.querySelector('#minMatchesFilterGroup .filter-btn.active');
      const period = periodBtn ? periodBtn.getAttribute('data-value') : 'all';
      const sort = sortBtn ? sortBtn.getAttribute('data-value') : 'rating_desc';
      const minMatches = minMatchesBtn ? parseInt(minMatchesBtn.getAttribute('data-value')) || 0 : 0;

      // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º map –∏–≥—Ä–æ–∫–æ–≤ —Å –∏—Ö —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ team.players
      const playerProfileMap = new Map(); // name -> {team, photoUrl, teamLogoUrl}
      allTeams.forEach(team => {
        if (Array.isArray(team.players)) {
          team.players.forEach(player => {
            if (player.name) {
              playerProfileMap.set(player.name.toLowerCase().trim(), {
                team: team.name,
                photoUrl: player.photoUrl || '',
                teamLogoUrl: team.logoUrl || ''
              });
            }
          });
        }
      });

      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å –∏—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞—Ç—á–µ–π
      const playersMap = new Map(); // name -> {team, matches, wins, ratingSum, photoUrl, teamLogoUrl}

      allTeams.forEach(team => {
        const historyToUse = filterHistoryByPeriod(team.history, period);
        if (Array.isArray(historyToUse)) {
          historyToUse.forEach((match, matchIdx) => {
            // –ò—â–µ–º playerStats –∏–ª–∏ players –∏–ª–∏ playerSeriesStats
            let playersList = null;
            if (Array.isArray(match.playerStats)) {
              playersList = match.playerStats;
            } else if (Array.isArray(match.players)) {
              playersList = match.players;
            } else if (match.playerSeriesStats && Array.isArray(match.playerSeriesStats.team1)) {
              // –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±–µ –∫–æ–º–∞–Ω–¥—ã –µ—Å–ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º–∞—Ç —Å playerSeriesStats
              playersList = [...match.playerSeriesStats.team1, ...match.playerSeriesStats.team2];
            }

            if (playersList) {
              playersList.forEach(player => {
                const playerName = player.name;
                if (!playerName) return;
                
                const playerKey = playerName.toLowerCase().trim();
                const profileData = playerProfileMap.get(playerKey) || {};

                // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –µ—Å—Ç—å –≤ map, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                const kills = (player.kills || 0);
                const deaths = (player.deaths || 0);
                // mvp may be stored on match.mvp or player.mvp
                const isMvp = (match && match.mvp && match.mvp.name && match.mvp.name === playerName) || player.mvp === true || player.mvp === 1;

                if (playersMap.has(playerKey)) {
                  const playerData = playersMap.get(playerKey);
                  playerData.matches++;
                  const rating = player.rating2 || player.rating || 0;
                  playerData.ratingSum += rating;
                  playerData.kills += kills;
                  playerData.deaths += deaths;
                  if (isMvp) playerData.mvpCount++;
                  if (match.result === 'Win') {
                    playerData.wins++;
                  }
                } else {
                  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
                  playersMap.set(playerKey, {
                    name: playerName,
                    team: profileData.team || team.name,
                    teamLogoUrl: profileData.teamLogoUrl || team.logoUrl || '',
                    photoUrl: profileData.photoUrl || player.photoUrl || '',
                    matches: 1,
                    wins: match.result === 'Win' ? 1 : 0,
                    ratingSum: player.rating2 || player.rating || 0,
                    kills: kills,
                    deaths: deaths,
                    mvpCount: isMvp ? 1 : 0
                  });
                }
              });
            }
          });
        }
      });

      console.log('Total unique players found:', playersMap.size);
      console.log('Players map:', Array.from(playersMap.values()).slice(0, 5));

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –Ω–∞–≥—Ä–∞–¥ –∏–≥—Ä–æ–∫–∞ (–∏–∑ –∫–æ–º–∞–Ω–¥—ã + –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)
      function collectPlayerAwards(playerName, teamName) {
        let awards = [];
        
        // –ù–∞–≥—Ä–∞–¥—ã –∏–∑ –∫–æ–º–∞–Ω–¥—ã
        const team = allTeams.find(t => t.name === teamName);
        if (team && Array.isArray(team.awards) && team.awards.length > 0) {
          awards = [...team.awards];
        }
        
        // –ù–∞–≥—Ä–∞–¥—ã –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å –Ω–∞–≥—Ä–∞–¥–∞–º–∏ –∫–æ–º–∞–Ω–¥—ã)
        if (window.playerAwardsStore && typeof window.playerAwardsStore.getAwards === 'function') {
          const storedAwards = window.playerAwardsStore.getAwards(playerName);
          if (storedAwards && storedAwards.length > 0) {
            if (window.playerAwardsStore.mergeAwards) {
              awards = window.playerAwardsStore.mergeAwards(awards, storedAwards);
            } else {
              // –ü—Ä–æ—Å—Ç–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
              storedAwards.forEach(award => {
                const exists = awards.some(a => a.name === award.name && a.img === award.img);
                if (!exists) {
                  awards.push(award);
                }
              });
            }
          }
        }
        
        return awards;
      }

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è, –≤–∫–ª—é—á–∞—è –Ω–∞–≥—Ä–∞–¥—ã
      let playersData = Array.from(playersMap.values()).map(p => {
        const awards = collectPlayerAwards(p.name, p.team);
        return {
          ...p,
          avgRating: p.matches > 0 ? (p.ratingSum / p.matches).toFixed(2) : 0,
          winRate: p.matches > 0 ? Math.round((p.wins / p.matches) * 100) : 0,
          kd: p.deaths > 0 ? (p.kills / p.deaths) : (p.kills > 0 ? p.kills : 0),
          mvpCount: p.mvpCount || 0,
          awardsCount: awards.length || 0
        };
      });

      // Compute composite score for each player
      function computeCompositeScore(p) {
        // p.winRate: 0-100
        // p.kd: ratio, normalize by capping at 4.0
        // p.avgRating: typical ~0.5-1.5, normalize against 1.5
        // p.mvpCount per match -> mvpPerMatch
        // p.matches - —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ (20% –≤–º–µ—Å—Ç–æ 40%)
        // p.awardsCount - –Ω–æ–≤–æ–µ: –≤–ª–∏—è–Ω–∏–µ —Ç—Ä–æ—Ñ–µ–µ–≤ (5%)
        const winScore = p.winRate || 0; // 0..100
        const kdNorm = Math.min(p.kd || 0, 4) / 4 * 100; // 0..100
        const ratingNorm = Math.min(parseFloat(p.avgRating) || 0, 1.5) / 1.5 * 100; // 0..100
        const mvpPerMatch = (p.matches && p.mvpCount) ? (p.mvpCount / p.matches) : 0;
        const mvpNorm = Math.min(mvpPerMatch, 1) * 100; // capped at 1 per match

        // Normalize matches: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
        // –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∏–≥—Ä–æ–∫–∏ —Å –º–∞–ª—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–∞—Ç—á–µ–π –ø–æ–ª—É—á–∞—Ç –µ—â–µ –º–µ–Ω—å—à–µ –±–∞–ª–ª–æ–≤
        const capMatches = 100; // 100 –º–∞—Ç—á–µ–π -> full score (—É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–≥–æ –æ—Ç–±–æ—Ä–∞)
        const matchesRaw = Math.min(p.matches || 0, capMatches) / capMatches; // 0..1
        const matchesNorm = Math.sqrt(matchesRaw) * 100; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–π –æ—Ü–µ–Ω–∫–∏

        // Normalize trophies: cap at 10 trophies for full score
        const capTrophies = 10; // 10 —Ç—Ä–æ—Ñ–µ–µ–≤ -> full score
        const trophiesNorm = Math.min(p.awardsCount || 0, capTrophies) / capTrophies * 100; // 0..100

        // New weights: matches 25% (—É–≤–µ–ª–∏—á–µ–Ω–æ), win 15%, kd 15%, rating 25%, mvp 12%, trophies 8%
        const score = (matchesNorm * 0.25) + (winScore * 0.15) + (kdNorm * 0.15) + (ratingNorm * 0.25) + (mvpNorm * 0.12) + (trophiesNorm * 0.08);
        return score;
      }

      playersData = playersData.map(p => ({ ...p, compositeScore: computeCompositeScore(p) }));

      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–∞—Ç—á–µ–π
      playersData = playersData.filter(p => p.matches >= minMatches);

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
      const searchInput = document.getElementById('playerSearch');
      const searchTerm = searchInput && searchInput.value ? searchInput.value.trim().toLowerCase() : '';
      if (searchTerm) {
        playersData = playersData.filter(p => p.name.toLowerCase().includes(searchTerm));
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º
      switch (sort) {
        case 'rating_desc':
          playersData.sort((a, b) => b.avgRating - a.avgRating);
          break;
        case 'rating_asc':
          playersData.sort((a, b) => a.avgRating - b.avgRating);
          break;
        case 'matches':
          playersData.sort((a, b) => b.matches - a.matches);
          break;
        case 'composite':
          playersData.sort((a, b) => b.compositeScore - a.compositeScore);
          break;
      }

      if (playersData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–≥—Ä–æ–∫–∞—Ö</td></tr>';
        return;
      }

      tbody.innerHTML = playersData.map((player, idx) => `
        <tr data-name="${player.name.toLowerCase()}" class="border-b border-gray-700 hover:bg-gray-700/30 transition">
          <td class="px-6 py-4 font-bold text-gray-300">${idx + 1}</td>
          <td class="px-6 py-4">
            <a href="player-profile.html?player=${encodeURIComponent(player.name)}&team=${encodeURIComponent(player.team)}" class="flex items-center gap-3 hover:text-blue-400 transition cursor-pointer">
              ${player.photoUrl ? `<img src="${player.photoUrl}" alt="${player.name}" class="w-8 h-8 rounded-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : ''}
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white" style="${player.photoUrl ? 'display:none;' : ''}">
                ${player.name.charAt(0).toUpperCase()}
              </div>
              <span class="font-semibold hover:underline">${player.name}</span>
            </a>
          </td>
          <td class="px-6 py-4 text-gray-400">
            <div class="flex items-center gap-2">
              ${player.teamLogoUrl ? `<img src="${player.teamLogoUrl}" alt="${player.team}" class="w-6 h-6 rounded object-cover" onerror="this.style.display='none';">` : ''}
              <span>${player.team}</span>
            </div>
          </td>
          <td class="px-6 py-4 text-center">${player.matches}</td>
          <td class="px-6 py-4 text-center">
            <span class="text-lg font-bold ${parseFloat(player.avgRating) >= 1.2 ? 'text-green-400' : parseFloat(player.avgRating) >= 1.0 ? 'text-yellow-400' : 'text-red-400'}">
              ${player.avgRating}
            </span>
          </td>
          <td class="px-6 py-4 text-center font-bold text-indigo-300">${(player.compositeScore||0).toFixed(1)}</td>
          <td class="px-6 py-4 text-center text-green-400 font-semibold">${player.wins}</td>
          <td class="px-6 py-4 text-center">
            <span class="px-3 py-1 rounded-full font-semibold ${player.winRate >= 60 ? 'bg-green-500/20 text-green-400' : player.winRate >= 40 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'}">
              ${player.winRate}%
            </span>
          </td>
          <td class="px-6 py-4 text-center">
            <a href="player-profile.html?player=${encodeURIComponent(player.name)}&team=${encodeURIComponent(player.team)}" class="text-blue-400 hover:text-blue-300 hover:underline">
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </a>
          </td>
        </tr>
      `).join('');

      // Highlight search results and manage focus index
      const allRows = Array.from(tbody.querySelectorAll('tr[data-name]'));
      allRows.forEach(r => r.classList.remove('player-highlight'));
      if (searchTerm && allRows.length > 0) {
        // highlight all matches
        allRows.forEach(r => {
          if (r.getAttribute('data-name').includes(searchTerm)) r.classList.add('player-highlight');
        });
        // scroll first into view
        const first = allRows.find(r => r.classList.contains('player-highlight'));
        if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    function initFilterButtons(groupId, defaultValue, onChange) {
      const group = document.getElementById(groupId);
      if (!group) return;
      
      // –ù–∞—Ö–æ–¥–∏–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const defaultBtn = group.querySelector(`[data-value="${defaultValue}"]`);
      if (defaultBtn) {
        defaultBtn.classList.add('active');
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏
      group.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const value = btn.getAttribute('data-value');
          
          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ –≥—Ä—É–ø–ø–µ
          group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          
          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
          btn.classList.add('active');
          
          // –í—ã–∑—ã–≤–∞–µ–º callback
          if (onChange) onChange(value);
        });
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    function initFilters() {
      initFilterButtons('periodFilterGroup', 'all', (value) => {
        console.log('Period changed to:', value);
        currentPeriod = value;
        renderPlayersTable();
      });

      initFilterButtons('sortFilterGroup', 'rating_desc', (value) => {
        console.log('Sort changed to:', value);
        currentSort = value;
        renderPlayersTable();
      });

      initFilterButtons('minMatchesFilterGroup', '0', (value) => {
        console.log('Min matches filter changed to:', value);
        renderPlayersTable();
      });
    }

    // Search input behavior: re-render on input; Enter navigates to next match
    (function() {
      const searchEl = document.getElementById('playerSearch');
      if (!searchEl) return;
      let lastIndex = -1;
      searchEl.addEventListener('input', () => {
        lastIndex = -1;
        renderPlayersTable();
      });
      searchEl.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          const tbody = document.getElementById('playersTableBody');
          const rows = Array.from(tbody.querySelectorAll('tr.player-highlight'));
          if (rows.length === 0) return;
          lastIndex = (lastIndex + 1) % rows.length;
          const target = rows[lastIndex];
          target.classList.add('player-highlight');
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    })();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      initFilters();
      loadTeamsData();
    });
  </script>
</body>
</html>
